\hypertarget{a00038}{}\section{libc/ext/liballoc.h File Reference}
\label{a00038}\index{libc/ext/liballoc.\+h@{libc/ext/liballoc.\+h}}
This graph shows which files directly or indirectly include this file\+:
% FIG 0
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{a00126}{boundary\+\_\+tag}
\begin{DoxyCompactList}\small\item\em This is a boundary tag which is prepended to the page or section of a page which we have allocated. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{a00038_a40684528083f4cc0dfe3ca1accae3f79_a40684528083f4cc0dfe3ca1accae3f79}{\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T}
\begin{DoxyCompactList}\small\item\em This code is released into the public domain. \end{DoxyCompactList}\item 
\#define \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{N\+U\+LL}~0
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef unsigned int \hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}{liballoc\+\_\+lock} ()
\begin{DoxyCompactList}\small\item\em This function is supposed to lock the memory data structures. \end{DoxyCompactList}\item 
int \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\+\_\+unlock} ()
\begin{DoxyCompactList}\small\item\em This function unlocks what was previously locked by the liballoc\+\_\+lock function. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{a00038_ae002bb742dfc63fe18a305bd14bdf692_ae002bb742dfc63fe18a305bd14bdf692}{liballoc\+\_\+alloc} (int)
\begin{DoxyCompactList}\small\item\em This is the hook into the local system which allocates pages. \end{DoxyCompactList}\item 
int \hyperlink{a00038_a1653870893230580e5d605148aa3c37a_a1653870893230580e5d605148aa3c37a}{liballoc\+\_\+free} (void $\ast$, int)
\begin{DoxyCompactList}\small\item\em This frees previously allocated memory. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{a00038_a1c8580582aae58105f16108d4ec89e9a_a1c8580582aae58105f16108d4ec89e9a}{malloc} (\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t})
\item 
void $\ast$ \hyperlink{a00038_afa148085b6fa9594b4c35e100d94a183_afa148085b6fa9594b4c35e100d94a183}{realloc} (void $\ast$, \hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t})
\item 
void $\ast$ \hyperlink{a00038_a77e880b1033d5a912be4333fc5d31eef_a77e880b1033d5a912be4333fc5d31eef}{calloc} (\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}, \hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t})
\item 
void \hyperlink{a00038_af07d89f5ceaea0c7c8252cc41fd75f37_af07d89f5ceaea0c7c8252cc41fd75f37}{free} (void $\ast$)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{a00038_a40684528083f4cc0dfe3ca1accae3f79_a40684528083f4cc0dfe3ca1accae3f79}\label{a00038_a40684528083f4cc0dfe3ca1accae3f79_a40684528083f4cc0dfe3ca1accae3f79}} 
\index{liballoc.\+h@{liballoc.\+h}!\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T@{\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T}}
\index{\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T@{\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{\+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T}{\_HAVE\_SIZE\_T}}
{\footnotesize\ttfamily \#define \+\_\+\+H\+A\+V\+E\+\_\+\+S\+I\+Z\+E\+\_\+T}



This code is released into the public domain. 

Use this code at your own risk. Feel free to use it for whatever purpose you want. I take no responsibilty or whatever if anything goes wrong. Use it at your own risk.

If you have any fixes or patches, please email me.

Durand Miller \href{mailto:clutter@djm.co.za}{\tt clutter@djm.\+co.\+za} 

Definition at line 21 of file liballoc.\+h.

\mbox{\Hypertarget{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}\label{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}} 
\index{liballoc.\+h@{liballoc.\+h}!N\+U\+LL@{N\+U\+LL}}
\index{N\+U\+LL@{N\+U\+LL}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{N\+U\+LL}{NULL}}
{\footnotesize\ttfamily \#define N\+U\+LL~0}



Definition at line 27 of file liballoc.\+h.



\subsection{Typedef Documentation}
\mbox{\Hypertarget{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}\label{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}} 
\index{liballoc.\+h@{liballoc.\+h}!size\+\_\+t@{size\+\_\+t}}
\index{size\+\_\+t@{size\+\_\+t}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{size\+\_\+t}{size\_t}}
{\footnotesize\ttfamily typedef unsigned int \hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}}



Definition at line 22 of file liballoc.\+h.



\subsection{Function Documentation}
\mbox{\Hypertarget{a00038_a77e880b1033d5a912be4333fc5d31eef_a77e880b1033d5a912be4333fc5d31eef}\label{a00038_a77e880b1033d5a912be4333fc5d31eef_a77e880b1033d5a912be4333fc5d31eef}} 
\index{liballoc.\+h@{liballoc.\+h}!calloc@{calloc}}
\index{calloc@{calloc}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{calloc()}{calloc()}}
{\footnotesize\ttfamily void$\ast$ calloc (\begin{DoxyParamCaption}\item[{\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}}]{,  }\item[{\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}}]{ }\end{DoxyParamCaption})}



Definition at line 500 of file liballoc.\+c.


\begin{DoxyCode}
501 \{
502        \textcolor{keywordtype}{int} \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size};
503        \textcolor{keywordtype}{void} *p;
504 
505        real\_size = nobj * \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
506        
507        p = \hyperlink{a00035_a7ac38fce3243a7dcf448301ee9ffd392_a7ac38fce3243a7dcf448301ee9ffd392}{malloc}( real\_size );
508 
509        \hyperlink{a00035_ad824e94da51543e1febb05f96f0083ba_ad824e94da51543e1febb05f96f0083ba}{liballoc\_memset}( p, 0, real\_size );
510 
511        \textcolor{keywordflow}{return} p;
512 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_af07d89f5ceaea0c7c8252cc41fd75f37_af07d89f5ceaea0c7c8252cc41fd75f37}\label{a00038_af07d89f5ceaea0c7c8252cc41fd75f37_af07d89f5ceaea0c7c8252cc41fd75f37}} 
\index{liballoc.\+h@{liballoc.\+h}!free@{free}}
\index{free@{free}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{free()}{free()}}
{\footnotesize\ttfamily void free (\begin{DoxyParamCaption}\item[{void $\ast$}]{ }\end{DoxyParamCaption})}



Definition at line 405 of file liballoc.\+c.


\begin{DoxyCode}
406 \{
407     \textcolor{keywordtype}{int} \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index};
408     \textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag} *tag;
409 
410     \textcolor{keywordflow}{if} ( ptr == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} ) \textcolor{keywordflow}{return};
411 
412     \hyperlink{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}{liballoc\_lock}();
413     
414 
415         tag = (\textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag}*)((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int})ptr - \textcolor{keyword}{sizeof}( \textcolor{keyword}{struct }
      \hyperlink{a00126}{boundary\_tag} ));
416     
417         \textcolor{keywordflow}{if} ( tag->\hyperlink{a00126_a96a8bec3c60c81b8c41239169ec70b6c_a96a8bec3c60c81b8c41239169ec70b6c}{magic} != \hyperlink{a00035_af6b1d459ffa3c81e2456acf8d4268330_af6b1d459ffa3c81e2456acf8d4268330}{LIBALLOC\_MAGIC} ) 
418         \{
419             \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();       \textcolor{comment}{// release the lock}
420             \textcolor{keywordflow}{return};
421         \}
422 
423 
424 
425 \textcolor{preprocessor}{        #ifdef DEBUG}
426         l\_inuse -= tag->\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
427         printf(\textcolor{stringliteral}{"free: %x, %i, %i\(\backslash\)n"}, ptr, (\textcolor{keywordtype}{int})l\_inuse / 1024, (\textcolor{keywordtype}{int})l\_allocated / 1024 );
428 \textcolor{preprocessor}{        #endif}
429         
430 
431         \textcolor{comment}{// MELT LEFT...}
432         \textcolor{keywordflow}{while} ( (tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left} != \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) && (tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left}->
      \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} >= 0) )
433         \{
434 \textcolor{preprocessor}{            #ifdef DEBUG}
435             printf(\textcolor{stringliteral}{"Melting tag left into available memory. Left was %i, becomes %i (%i)\(\backslash\)n"}, tag->
      \hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left}->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left}->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} + tag->
      \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left}->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} );
436 \textcolor{preprocessor}{            #endif}
437             tag = \hyperlink{a00035_a7ea762780416b837601691f20e085cc2_a7ea762780416b837601691f20e085cc2}{melt\_left}( tag );
438             \hyperlink{a00035_aeea23ead928f2a5d40fdf7687b3c99c9_aeea23ead928f2a5d40fdf7687b3c99c9}{remove\_tag}( tag );
439         \}
440 
441         \textcolor{comment}{// MELT RIGHT...}
442         \textcolor{keywordflow}{while} ( (tag->\hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right} != \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) && (tag->\hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right}->
      \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} >= 0) )
443         \{
444 \textcolor{preprocessor}{            #ifdef DEBUG}
445             printf(\textcolor{stringliteral}{"Melting tag right into available memory. This was was %i, becomes %i (%i)\(\backslash\)n"}, tag->
      \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, tag->\hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right}->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} + tag->
      \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, tag->\hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right}->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} );
446 \textcolor{preprocessor}{            #endif}
447             tag = \hyperlink{a00035_a9d9646746f3401f7c03ff66cba7315c8_a9d9646746f3401f7c03ff66cba7315c8}{absorb\_right}( tag );
448         \}
449 
450         
451         \textcolor{comment}{// Where is it going back to?}
452         index = \hyperlink{a00035_ab5fc0b977bf14bdb99c8b87cae451d42_ab5fc0b977bf14bdb99c8b87cae451d42}{getexp}( tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} 
      \hyperlink{a00126}{boundary\_tag}) );
453         \textcolor{keywordflow}{if} ( index < \hyperlink{a00035_ae7249b0af4d1bfe02a4c7bdbf810bd8c_ae7249b0af4d1bfe02a4c7bdbf810bd8c}{MINEXP} ) index = \hyperlink{a00035_ae7249b0af4d1bfe02a4c7bdbf810bd8c_ae7249b0af4d1bfe02a4c7bdbf810bd8c}{MINEXP};
454         
455         \textcolor{comment}{// A whole, empty block?}
456         \textcolor{keywordflow}{if} ( (tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left} == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) && (tag->\hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right} == 
      \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) )
457         \{   
458 
459             \textcolor{keywordflow}{if} ( \hyperlink{a00035_a213db3baf1d4b13d604015489247980d_a213db3baf1d4b13d604015489247980d}{l\_completePages}[ index ] == \hyperlink{a00035_a08b7f1e029a0c835f3639557d8ad7a36_a08b7f1e029a0c835f3639557d8ad7a36}{MAXCOMPLETE} )
460             \{
461                 \textcolor{comment}{// Too many standing by to keep. Free this one.}
462                 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} pages = tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} / \hyperlink{a00035_a5008d6a07ef0a4f9e325993716cc228e_a5008d6a07ef0a4f9e325993716cc228e}{l\_pageSize};
463 
464                 \textcolor{keywordflow}{if} ( (tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} % \hyperlink{a00035_a5008d6a07ef0a4f9e325993716cc228e_a5008d6a07ef0a4f9e325993716cc228e}{l\_pageSize}) != 0 ) pages += 1;
465                 \textcolor{keywordflow}{if} ( pages < \hyperlink{a00035_a8f81c0408f42ca5d936221d15f918275_a8f81c0408f42ca5d936221d15f918275}{l\_pageCount} ) pages = \hyperlink{a00035_a8f81c0408f42ca5d936221d15f918275_a8f81c0408f42ca5d936221d15f918275}{l\_pageCount};
466 
467                 \hyperlink{a00038_a1653870893230580e5d605148aa3c37a_a1653870893230580e5d605148aa3c37a}{liballoc\_free}( tag, pages );
468 
469 \textcolor{preprocessor}{                #ifdef DEBUG}
470                 l\_allocated -= pages * \hyperlink{a00035_a5008d6a07ef0a4f9e325993716cc228e_a5008d6a07ef0a4f9e325993716cc228e}{l\_pageSize};
471                 printf(\textcolor{stringliteral}{"Resource freeing %x of %i pages\(\backslash\)n"}, tag, pages );
472                 dump\_array();
473 \textcolor{preprocessor}{                #endif}
474 
475                 \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();
476                 \textcolor{keywordflow}{return};
477             \}
478 
479 
480             \hyperlink{a00035_a213db3baf1d4b13d604015489247980d_a213db3baf1d4b13d604015489247980d}{l\_completePages}[ \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} ] += 1;  \textcolor{comment}{// Increase the count of complete pages.}
481         \}
482 
483 
484         \textcolor{comment}{// ..........}
485 
486 
487         \hyperlink{a00035_a569f88ed08d8435e256dd225afcd26df_a569f88ed08d8435e256dd225afcd26df}{insert\_tag}( tag, index );
488 
489 \textcolor{preprocessor}{    #ifdef DEBUG}
490     printf(\textcolor{stringliteral}{"Returning tag with %i bytes (requested %i bytes), which has exponent: %i\(\backslash\)n"}, tag->
      \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, tag->\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size}, index ); 
491     dump\_array();
492 \textcolor{preprocessor}{    #endif}
493 
494     \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();
495 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_ae002bb742dfc63fe18a305bd14bdf692_ae002bb742dfc63fe18a305bd14bdf692}\label{a00038_ae002bb742dfc63fe18a305bd14bdf692_ae002bb742dfc63fe18a305bd14bdf692}} 
\index{liballoc.\+h@{liballoc.\+h}!liballoc\+\_\+alloc@{liballoc\+\_\+alloc}}
\index{liballoc\+\_\+alloc@{liballoc\+\_\+alloc}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{liballoc\+\_\+alloc()}{liballoc\_alloc()}}
{\footnotesize\ttfamily void$\ast$ liballoc\+\_\+alloc (\begin{DoxyParamCaption}\item[{int}]{ }\end{DoxyParamCaption})}



This is the hook into the local system which allocates pages. 

It accepts an integer parameter which is the number of pages required. The page size was set up in the liballoc\+\_\+init function.

\begin{DoxyReturn}{Returns}
N\+U\+LL if the pages were not allocated. 

A pointer to the allocated memory. 
\end{DoxyReturn}


Definition at line 11 of file liballoc\+\_\+hook.\+c.


\begin{DoxyCode}
11                                 \{
12 
13 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_a1653870893230580e5d605148aa3c37a_a1653870893230580e5d605148aa3c37a}\label{a00038_a1653870893230580e5d605148aa3c37a_a1653870893230580e5d605148aa3c37a}} 
\index{liballoc.\+h@{liballoc.\+h}!liballoc\+\_\+free@{liballoc\+\_\+free}}
\index{liballoc\+\_\+free@{liballoc\+\_\+free}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{liballoc\+\_\+free()}{liballoc\_free()}}
{\footnotesize\ttfamily int liballoc\+\_\+free (\begin{DoxyParamCaption}\item[{void $\ast$}]{,  }\item[{int}]{ }\end{DoxyParamCaption})}



This frees previously allocated memory. 

The void$\ast$ parameter passed to the function is the exact same value returned from a previous liballoc\+\_\+alloc call.

The integer value is the number of pages to free.

\begin{DoxyReturn}{Returns}
0 if the memory was successfully freed. 
\end{DoxyReturn}


Definition at line 15 of file liballoc\+\_\+hook.\+c.


\begin{DoxyCode}
15                                         \{
16 
17 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}\label{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}} 
\index{liballoc.\+h@{liballoc.\+h}!liballoc\+\_\+lock@{liballoc\+\_\+lock}}
\index{liballoc\+\_\+lock@{liballoc\+\_\+lock}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{liballoc\+\_\+lock()}{liballoc\_lock()}}
{\footnotesize\ttfamily int liballoc\+\_\+lock (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



This function is supposed to lock the memory data structures. 

It could be as simple as disabling interrupts or acquiring a spinlock. It\textquotesingle{}s up to you to decide.

\begin{DoxyReturn}{Returns}
0 if the lock was acquired successfully. Anything else is failure. 
\end{DoxyReturn}


Definition at line 3 of file liballoc\+\_\+hook.\+c.


\begin{DoxyCode}
3                     \{
4     \textcolor{keywordflow}{return} 0;
5 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}\label{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}} 
\index{liballoc.\+h@{liballoc.\+h}!liballoc\+\_\+unlock@{liballoc\+\_\+unlock}}
\index{liballoc\+\_\+unlock@{liballoc\+\_\+unlock}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{liballoc\+\_\+unlock()}{liballoc\_unlock()}}
{\footnotesize\ttfamily int liballoc\+\_\+unlock (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



This function unlocks what was previously locked by the liballoc\+\_\+lock function. 

If it disabled interrupts, it enables interrupts. If it had acquiried a spinlock, it releases the spinlock. etc.

\begin{DoxyReturn}{Returns}
0 if the lock was successfully released. 
\end{DoxyReturn}


Definition at line 7 of file liballoc\+\_\+hook.\+c.


\begin{DoxyCode}
7                       \{
8     \textcolor{keywordflow}{return} 0;
9 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_a1c8580582aae58105f16108d4ec89e9a_a1c8580582aae58105f16108d4ec89e9a}\label{a00038_a1c8580582aae58105f16108d4ec89e9a_a1c8580582aae58105f16108d4ec89e9a}} 
\index{liballoc.\+h@{liballoc.\+h}!malloc@{malloc}}
\index{malloc@{malloc}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{malloc()}{malloc()}}
{\footnotesize\ttfamily void$\ast$ malloc (\begin{DoxyParamCaption}\item[{\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}}]{ }\end{DoxyParamCaption})}



Definition at line 290 of file liballoc.\+c.


\begin{DoxyCode}
291 \{
292     \textcolor{keywordtype}{int} \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index};
293     \textcolor{keywordtype}{void} *ptr;
294     \textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag} *tag = \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
295 
296     \hyperlink{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}{liballoc\_lock}();
297 
298         \textcolor{keywordflow}{if} ( \hyperlink{a00035_a4aac6ed0ba0144598c5abe18222c3493_a4aac6ed0ba0144598c5abe18222c3493}{l\_initialized} == 0 )
299         \{
300 \textcolor{preprocessor}{            #ifdef DEBUG}
301             printf(\textcolor{stringliteral}{"%s\(\backslash\)n"},\textcolor{stringliteral}{"liballoc initializing."});
302 \textcolor{preprocessor}{            #endif}
303             \textcolor{keywordflow}{for} ( index = 0; index < \hyperlink{a00035_af823bb7d083fafbd662be7ea09582013_af823bb7d083fafbd662be7ea09582013}{MAXEXP}; index++ )
304             \{
305                 \hyperlink{a00035_a78b8b6e448179d3cd64915f99fee60e0_a78b8b6e448179d3cd64915f99fee60e0}{l\_freePages}[\hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index}] = \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
306                 \hyperlink{a00035_a213db3baf1d4b13d604015489247980d_a213db3baf1d4b13d604015489247980d}{l\_completePages}[\hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index}] = 0;
307             \}
308             \hyperlink{a00035_a4aac6ed0ba0144598c5abe18222c3493_a4aac6ed0ba0144598c5abe18222c3493}{l\_initialized} = 1;
309         \}
310 
311         index = \hyperlink{a00035_ab5fc0b977bf14bdb99c8b87cae451d42_ab5fc0b977bf14bdb99c8b87cae451d42}{getexp}( \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} ) + \hyperlink{a00035_ab8c52c1b4c021ed3e6b6b677bd2ac019_ab8c52c1b4c021ed3e6b6b677bd2ac019}{MODE};
312         \textcolor{keywordflow}{if} ( index < \hyperlink{a00035_ae7249b0af4d1bfe02a4c7bdbf810bd8c_ae7249b0af4d1bfe02a4c7bdbf810bd8c}{MINEXP} ) index = \hyperlink{a00035_ae7249b0af4d1bfe02a4c7bdbf810bd8c_ae7249b0af4d1bfe02a4c7bdbf810bd8c}{MINEXP};
313         
314 
315         \textcolor{comment}{// Find one big enough.}
316             tag = \hyperlink{a00035_a78b8b6e448179d3cd64915f99fee60e0_a78b8b6e448179d3cd64915f99fee60e0}{l\_freePages}[ \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} ];             \textcolor{comment}{// Start at the front of the list.}
317             \textcolor{keywordflow}{while} ( tag != \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} )
318             \{
319                     \textcolor{comment}{// If there's enough space in this tag.}
320                 \textcolor{keywordflow}{if} ( (tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{a00126}{boundary\_tag}))
321                                 >= (\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} + \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{a00126}{boundary\_tag}) ) )
322                 \{
323 \textcolor{preprocessor}{                    #ifdef DEBUG}
324                     printf(\textcolor{stringliteral}{"Tag search found %i >= %i\(\backslash\)n"},(tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} 
      \hyperlink{a00126}{boundary\_tag})), (\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} + \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{a00126}{boundary\_tag}) ) );
325 \textcolor{preprocessor}{                    #endif}
326                     \textcolor{keywordflow}{break};
327                 \}
328 
329                 tag = tag->\hyperlink{a00126_a123f0bd815d7fda9f535b031640662fc_a123f0bd815d7fda9f535b031640662fc}{next};
330             \}
331 
332         
333             \textcolor{comment}{// No page found. Make one.}
334             \textcolor{keywordflow}{if} ( tag == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} )
335             \{   
336                 \textcolor{keywordflow}{if} ( (tag = \hyperlink{a00035_a8e465ea231c950756bcd4e41244c61a1_a8e465ea231c950756bcd4e41244c61a1}{allocate\_new\_tag}( \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} )) == 
      \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} )
337                 \{
338                     \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();
339                     \textcolor{keywordflow}{return} \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
340                 \}
341                 
342                 index = \hyperlink{a00035_ab5fc0b977bf14bdb99c8b87cae451d42_ab5fc0b977bf14bdb99c8b87cae451d42}{getexp}( tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} 
      \hyperlink{a00126}{boundary\_tag}) );
343             \}
344             \textcolor{keywordflow}{else}
345             \{
346                 \hyperlink{a00035_aeea23ead928f2a5d40fdf7687b3c99c9_aeea23ead928f2a5d40fdf7687b3c99c9}{remove\_tag}( tag );
347 
348                 \textcolor{keywordflow}{if} ( (tag->\hyperlink{a00126_a4daa8c3768359ea8d0f46ef907616cc2_a4daa8c3768359ea8d0f46ef907616cc2}{split\_left} == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) && (tag->
      \hyperlink{a00126_a9d43c9c4ff5ae35908dcfed0aec1907a_a9d43c9c4ff5ae35908dcfed0aec1907a}{split\_right} == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) )
349                     \hyperlink{a00035_a213db3baf1d4b13d604015489247980d_a213db3baf1d4b13d604015489247980d}{l\_completePages}[ \hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} ] -= 1;
350             \}
351         
352         \textcolor{comment}{// We have a free page.  Remove it from the free pages list.}
353     
354         tag->\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} = \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
355 
356         \textcolor{comment}{// Removed... see if we can re-use the excess space.}
357 
358 \textcolor{preprocessor}{        #ifdef DEBUG}
359         printf(\textcolor{stringliteral}{"Found tag with %i bytes available (requested %i bytes, leaving %i), which has exponent: %i
       (%i bytes)\(\backslash\)n"}, tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{a00126}{boundary\_tag}), 
      \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size}, tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} - \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{a00126}{boundary\_tag}), index, 1<<index );
360 \textcolor{preprocessor}{        #endif}
361         
362         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} remainder = tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size} - \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} - \textcolor{keyword}{sizeof}( \textcolor{keyword}{struct }
      \hyperlink{a00126}{boundary\_tag} ) * 2; \textcolor{comment}{// Support a new tag + remainder}
363 
364         \textcolor{keywordflow}{if} ( ((\textcolor{keywordtype}{int})(remainder) > 0) \textcolor{comment}{/*&& ( (tag->real\_size - remainder) >= (1<<MINEXP))*/} )
365         \{
366             \textcolor{keywordtype}{int} childIndex = \hyperlink{a00035_ab5fc0b977bf14bdb99c8b87cae451d42_ab5fc0b977bf14bdb99c8b87cae451d42}{getexp}( remainder );
367     
368             \textcolor{keywordflow}{if} ( childIndex >= 0 )
369             \{
370 \textcolor{preprocessor}{                #ifdef DEBUG}
371                 printf(\textcolor{stringliteral}{"Seems to be splittable: %i >= 2^%i .. %i\(\backslash\)n"}, remainder, childIndex, (1<<childIndex)
       );
372 \textcolor{preprocessor}{                #endif}
373 
374                 \textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag} *new\_tag = \hyperlink{a00035_a8fd489a9d383dd6830e38fa63a0aec60_a8fd489a9d383dd6830e38fa63a0aec60}{split\_tag}( tag ); 
375 
376                 new\_tag = new\_tag;  \textcolor{comment}{// Get around the compiler warning about unused variables.}
377     
378 \textcolor{preprocessor}{                #ifdef DEBUG}
379                 printf(\textcolor{stringliteral}{"Old tag has become %i bytes, new tag is now %i bytes (%i exp)\(\backslash\)n"}, tag->
      \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, new\_tag->\hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size}, new\_tag->\hyperlink{a00126_adfc426eed5361508d62c6e8f484bd270_adfc426eed5361508d62c6e8f484bd270}{index} );
380 \textcolor{preprocessor}{                #endif}
381             \}   
382         \}
383         
384         
385 
386     ptr = (\textcolor{keywordtype}{void}*)((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int})tag + \textcolor{keyword}{sizeof}( \textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag} ) );
387 
388 
389     
390 \textcolor{preprocessor}{    #ifdef DEBUG}
391     l\_inuse += \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
392     printf(\textcolor{stringliteral}{"malloc: %x,  %i, %i\(\backslash\)n"}, ptr, (\textcolor{keywordtype}{int})l\_inuse / 1024, (\textcolor{keywordtype}{int})l\_allocated / 1024 );
393     dump\_array();
394 \textcolor{preprocessor}{    #endif}
395 
396 
397     \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();
398     \textcolor{keywordflow}{return} ptr;
399 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00038_afa148085b6fa9594b4c35e100d94a183_afa148085b6fa9594b4c35e100d94a183}\label{a00038_afa148085b6fa9594b4c35e100d94a183_afa148085b6fa9594b4c35e100d94a183}} 
\index{liballoc.\+h@{liballoc.\+h}!realloc@{realloc}}
\index{realloc@{realloc}!liballoc.\+h@{liballoc.\+h}}
\subsubsection{\texorpdfstring{realloc()}{realloc()}}
{\footnotesize\ttfamily void$\ast$ realloc (\begin{DoxyParamCaption}\item[{void $\ast$}]{,  }\item[{\hyperlink{a00038_a7c94ea6f8948649f8d181ae55911eeaf_a7c94ea6f8948649f8d181ae55911eeaf}{size\+\_\+t}}]{ }\end{DoxyParamCaption})}



Definition at line 516 of file liballoc.\+c.


\begin{DoxyCode}
517 \{
518     \textcolor{keywordtype}{void} *ptr;
519     \textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag} *tag;
520     \textcolor{keywordtype}{int} \hyperlink{a00126_ad22b1c69bdce419783ac165f7f354245_ad22b1c69bdce419783ac165f7f354245}{real\_size};
521     
522     \textcolor{keywordflow}{if} ( \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} == 0 )
523     \{
524         \hyperlink{a00035_afbedc913aa4651b3c3b4b3aecd9b4711_afbedc913aa4651b3c3b4b3aecd9b4711}{free}( p );
525         \textcolor{keywordflow}{return} \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
526     \}
527     \textcolor{keywordflow}{if} ( p == \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} ) \textcolor{keywordflow}{return} \hyperlink{a00035_a7ac38fce3243a7dcf448301ee9ffd392_a7ac38fce3243a7dcf448301ee9ffd392}{malloc}( \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} );
528 
529     \textcolor{keywordflow}{if} ( \hyperlink{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}{liballoc\_lock} != \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} ) \hyperlink{a00038_a8b5670e4594b0b6f8be78fe17f0c3b53_a8b5670e4594b0b6f8be78fe17f0c3b53}{liballoc\_lock}();     \textcolor{comment}{// lockit}
530         tag = (\textcolor{keyword}{struct }\hyperlink{a00126}{boundary\_tag}*)((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int})p - \textcolor{keyword}{sizeof}( \textcolor{keyword}{struct }
      \hyperlink{a00126}{boundary\_tag} ));
531         real\_size = tag->\hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
532     \textcolor{keywordflow}{if} ( \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock} != \hyperlink{a00038_a070d2ce7b6bb7e5c05602aa8c308d0c4_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} ) \hyperlink{a00038_aedc23f198b2882d41d0caa316453967b_aedc23f198b2882d41d0caa316453967b}{liballoc\_unlock}();
533 
534     \textcolor{keywordflow}{if} ( real\_size > \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} ) real\_size = \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size};
535 
536     ptr = \hyperlink{a00035_a7ac38fce3243a7dcf448301ee9ffd392_a7ac38fce3243a7dcf448301ee9ffd392}{malloc}( \hyperlink{a00126_a29b056a39f6022d32468e7913e6df936_a29b056a39f6022d32468e7913e6df936}{size} );
537     \hyperlink{a00035_a58b3101a659b6a2f7e2ca290bef6bfb4_a58b3101a659b6a2f7e2ca290bef6bfb4}{liballoc\_memcpy}( ptr, p, real\_size );
538     \hyperlink{a00035_afbedc913aa4651b3c3b4b3aecd9b4711_afbedc913aa4651b3c3b4b3aecd9b4711}{free}( p );
539 
540     \textcolor{keywordflow}{return} ptr;
541 \}
\end{DoxyCode}
