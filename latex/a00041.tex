\hypertarget{a00041}{}\section{drivers/keyboard.h File Reference}
\label{a00041}\index{drivers/keyboard.\+h@{drivers/keyboard.\+h}}
{\ttfamily \#include \char`\"{}../libc/vitality/inline.\+h\char`\"{}}\newline
Include dependency graph for keyboard.\+h\+:
% FIG 0
This graph shows which files directly or indirectly include this file\+:
% FIG 1
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{a00041_a49e0a04e81098085d2948c1e9f8c99cb_a49e0a04e81098085d2948c1e9f8c99cb}{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT}~0x60
\item 
\#define \hyperlink{a00041_ab79ca089665bc7f5cc151883d1bc69ed_ab79ca089665bc7f5cc151883d1bc69ed}{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT}~0x64
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{a00041_aabdb223e5290f3b3c07bc82d075b87d7_aabdb223e5290f3b3c07bc82d075b87d7}{kb\+\_\+init} (void)
\item 
char $\ast$ \hyperlink{a00041_ab88a2e96bbe585e228a5b201435c0240_ab88a2e96bbe585e228a5b201435c0240}{getst} ()
\item 
char \hyperlink{a00041_af3facad10e05defa48d45b46eb9ebe7e_af3facad10e05defa48d45b46eb9ebe7e}{getch} ()
\item 
void \hyperlink{a00041_adffe6abc4a32b3b10985ec9324bce2af_adffe6abc4a32b3b10985ec9324bce2af}{keyboard\+\_\+handler\+\_\+main} ()
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{a00041_a49e0a04e81098085d2948c1e9f8c99cb_a49e0a04e81098085d2948c1e9f8c99cb}\label{a00041_a49e0a04e81098085d2948c1e9f8c99cb_a49e0a04e81098085d2948c1e9f8c99cb}} 
\index{keyboard.\+h@{keyboard.\+h}!K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT@{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT}}
\index{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT@{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT}{KEYBOARD\_DATA\_PORT}}
{\footnotesize\ttfamily \#define K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+D\+A\+T\+A\+\_\+\+P\+O\+RT~0x60}



Definition at line 3 of file keyboard.\+h.

\mbox{\Hypertarget{a00041_ab79ca089665bc7f5cc151883d1bc69ed_ab79ca089665bc7f5cc151883d1bc69ed}\label{a00041_ab79ca089665bc7f5cc151883d1bc69ed_ab79ca089665bc7f5cc151883d1bc69ed}} 
\index{keyboard.\+h@{keyboard.\+h}!K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT@{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT}}
\index{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT@{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT}{KEYBOARD\_STATUS\_PORT}}
{\footnotesize\ttfamily \#define K\+E\+Y\+B\+O\+A\+R\+D\+\_\+\+S\+T\+A\+T\+U\+S\+\_\+\+P\+O\+RT~0x64}



Definition at line 4 of file keyboard.\+h.



\subsection{Function Documentation}
\mbox{\Hypertarget{a00041_af3facad10e05defa48d45b46eb9ebe7e_af3facad10e05defa48d45b46eb9ebe7e}\label{a00041_af3facad10e05defa48d45b46eb9ebe7e_af3facad10e05defa48d45b46eb9ebe7e}} 
\index{keyboard.\+h@{keyboard.\+h}!getch@{getch}}
\index{getch@{getch}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{getch()}{getch()}}
{\footnotesize\ttfamily char getch (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Definition at line 124 of file keyboard.\+c.


\begin{DoxyCode}
124              \{
125     \hyperlink{a00038_a6ddd5223379778858edc46ffbec19775_a6ddd5223379778858edc46ffbec19775}{wfk} = \textcolor{keyword}{true};
126     \textcolor{keywordflow}{while}(\hyperlink{a00038_a6ddd5223379778858edc46ffbec19775_a6ddd5223379778858edc46ffbec19775}{wfk})
127         ;
128     \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\hyperlink{a00038_ade374650022cb30c4f5591a8dafad685_ade374650022cb30c4f5591a8dafad685}{lkey});
129     \textcolor{keywordflow}{return} \hyperlink{a00038_ade374650022cb30c4f5591a8dafad685_ade374650022cb30c4f5591a8dafad685}{lkey};
130 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00041_ab88a2e96bbe585e228a5b201435c0240_ab88a2e96bbe585e228a5b201435c0240}\label{a00041_ab88a2e96bbe585e228a5b201435c0240_ab88a2e96bbe585e228a5b201435c0240}} 
\index{keyboard.\+h@{keyboard.\+h}!getst@{getst}}
\index{getst@{getst}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{getst()}{getst()}}
{\footnotesize\ttfamily char$\ast$ getst (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Definition at line 132 of file keyboard.\+c.


\begin{DoxyCode}
132               \{
133     \textcolor{keywordtype}{char}* inch;
134     \textcolor{keywordtype}{char} inchara = \hyperlink{a00038_af3facad10e05defa48d45b46eb9ebe7e_af3facad10e05defa48d45b46eb9ebe7e}{getch}();
135     \textcolor{keywordflow}{while}(inchara != \textcolor{charliteral}{'\(\backslash\)n'}) \{
136         *inch++ = inchara;
137         inchara = \hyperlink{a00038_af3facad10e05defa48d45b46eb9ebe7e_af3facad10e05defa48d45b46eb9ebe7e}{getch}();
138     \}
139     inch++;
140     *inch = 0x0;
141     \textcolor{keywordflow}{return} inch;
142 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00041_aabdb223e5290f3b3c07bc82d075b87d7_aabdb223e5290f3b3c07bc82d075b87d7}\label{a00041_aabdb223e5290f3b3c07bc82d075b87d7_aabdb223e5290f3b3c07bc82d075b87d7}} 
\index{keyboard.\+h@{keyboard.\+h}!kb\+\_\+init@{kb\+\_\+init}}
\index{kb\+\_\+init@{kb\+\_\+init}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{kb\+\_\+init()}{kb\_init()}}
{\footnotesize\ttfamily void kb\+\_\+init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Definition at line 54 of file keyboard.\+c.


\begin{DoxyCode}
55 \{
56     \textcolor{comment}{// disable devices}
57     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0xad);
58     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & \hyperlink{a00038_a8aa66e8bc828742fb4819d7cd2df598d_a8aa66e8bc828742fb4819d7cd2df598d}{SR\_CLEAR})
59         ;
60     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0xa7);
61     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_CLEAR)
62         ;
63     \textcolor{comment}{// flush output}
64     \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x60);
65     \textcolor{comment}{// set config}
66     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0x20);
67     \textcolor{keywordflow}{while}(!(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & \hyperlink{a00038_ac9efa716f8185bae296975136b510c30_ac9efa716f8185bae296975136b510c30}{SR\_RESPONSE}))
68         ;
69     \hyperlink{a00125_aba7bc1797add20fe3efdf37ced1182c5_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} config = \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x60);
70     \textcolor{keywordtype}{bool} dualchannel = \textcolor{keyword}{false};
71     \textcolor{keywordflow}{if}(config & \hyperlink{a00038_addafe32b109f94a57ae4bf1a1dca05e0_addafe32b109f94a57ae4bf1a1dca05e0}{SR\_DUALCHANNEL})
72         dualchannel = \textcolor{keyword}{true};
73     config &= ~(1 << 0);
74     config &= ~(1 << 1);
75     config &= ~(1 << 6);
76     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0x60);
77     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_CLEAR)
78         ;
79     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x60, config);
80 
81     \textcolor{comment}{// do self test}
82     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0xaa);
83     \textcolor{keywordflow}{while}(!(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_RESPONSE))
84         ;
85     \hyperlink{a00125_aba7bc1797add20fe3efdf37ced1182c5_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} response = \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x60);
86     \textcolor{keywordflow}{if}(response == 0x55) \{
87         \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"PS/2 OK.\(\backslash\)n"});
88     \} \textcolor{keywordflow}{else} \{
89         \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"PS/2 responded with 0xFC!!! The keyboard will not work.\(\backslash\)n"});
90     \}
91     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0xab);
92     \textcolor{keywordflow}{while}(!(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_RESPONSE))
93         ;
94     response = \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x60);
95     \textcolor{keywordflow}{switch}(response) \{
96         \textcolor{keywordflow}{case} 0x00:
97             \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"Keyboard test passed!\(\backslash\)n"});
98             \textcolor{keywordflow}{break};
99         \textcolor{keywordflow}{case} 0x01:
100             \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"Keyboard clock line struck low!\(\backslash\)n"});;
101             \textcolor{keywordflow}{break};
102         \textcolor{keywordflow}{case} 0x02:
103             \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"Keyboard clock line struck high!\(\backslash\)n"});
104             \textcolor{keywordflow}{break};
105         \textcolor{keywordflow}{case} 0x03:
106             \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"Keyboard data line struck low!\(\backslash\)n"});
107             \textcolor{keywordflow}{break};
108         \textcolor{keywordflow}{case} 0x04:
109             \hyperlink{a00149_ade960b1320324706aac6c00cc6b1b2fe_ade960b1320324706aac6c00cc6b1b2fe}{tty\_pputstring}(\textcolor{stringliteral}{"Keyboard data line struck high!\(\backslash\)n"});
110             \textcolor{keywordflow}{break};
111     \}
112     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_CLEAR)
113         ;
114     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0xae);
115     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_CLEAR)
116         ;
117     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x64, 0x60);
118     \textcolor{keywordflow}{while}(\hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(0x64) & SR\_CLEAR)
119         ;
120     config |= 1 << 0;
121     \hyperlink{a00140_aa37f5841c54156a4b14fc0d6f626b44f_aa37f5841c54156a4b14fc0d6f626b44f}{outb}(0x60, config);
122 \}
\end{DoxyCode}
\mbox{\Hypertarget{a00041_adffe6abc4a32b3b10985ec9324bce2af_adffe6abc4a32b3b10985ec9324bce2af}\label{a00041_adffe6abc4a32b3b10985ec9324bce2af_adffe6abc4a32b3b10985ec9324bce2af}} 
\index{keyboard.\+h@{keyboard.\+h}!keyboard\+\_\+handler\+\_\+main@{keyboard\+\_\+handler\+\_\+main}}
\index{keyboard\+\_\+handler\+\_\+main@{keyboard\+\_\+handler\+\_\+main}!keyboard.\+h@{keyboard.\+h}}
\subsubsection{\texorpdfstring{keyboard\+\_\+handler\+\_\+main()}{keyboard\_handler\_main()}}
{\footnotesize\ttfamily void keyboard\+\_\+handler\+\_\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Definition at line 144 of file keyboard.\+c.


\begin{DoxyCode}
144                                  \{
145     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} status;
146     \textcolor{keywordtype}{char} keycode;
147     status = \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(\hyperlink{a00041_ab79ca089665bc7f5cc151883d1bc69ed_ab79ca089665bc7f5cc151883d1bc69ed}{KEYBOARD\_STATUS\_PORT});
148     \textcolor{comment}{/* Lowest bit of status will be set if buffer is not empty */}
149     \textcolor{keywordflow}{if} (status & 0x01) \{
150         keycode = \hyperlink{a00140_a0223c8898dfec29069879dc51076e28a_a0223c8898dfec29069879dc51076e28a}{inb}(\hyperlink{a00041_a49e0a04e81098085d2948c1e9f8c99cb_a49e0a04e81098085d2948c1e9f8c99cb}{KEYBOARD\_DATA\_PORT});
151         \textcolor{keywordflow}{if}(keycode < 0)
152             \textcolor{keywordflow}{return};
153         \hyperlink{a00038_ade374650022cb30c4f5591a8dafad685_ade374650022cb30c4f5591a8dafad685}{lkey} = keycode;
154         \hyperlink{a00038_a6ddd5223379778858edc46ffbec19775_a6ddd5223379778858edc46ffbec19775}{wfk} = \textcolor{keyword}{false};
155     \}
156 \}
\end{DoxyCode}
